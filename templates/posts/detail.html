{% extends "base.html" %}

{% block title %}
  {{ detail.user.username }} | Post
{% endblock title %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card shadow-sm">

        <!-- Header -->
        <div class="card-header d-flex justify-content-between align-items-center">
          <a href="#" class="d-flex align-items-center gap-3 text-decoration-none text-dark">
            <img src="{{ detail.user.avatar.url }}" class="rounded-circle" width="45" height="45" style="object-fit: cover; border:1px solid #ddd;">
            <div>
              <a href="{% url 'profiles:profile' detail.user %}"><strong>{{ detail.user.username }}</strong><br></a>
              <small class="text-muted">{{ detail.create_at|date:"M d, Y" }}</small>
            </div>
          </a>
          <button class="btn btn-sm btn-light rounded-circle">â‹®</button>
        </div>

        <!-- Post Image -->
        <div class="card-body text-center">
          <img src="{{ detail.post.url }}" class="img-fluid rounded mb-3" style="max-height: 500px; object-fit: cover;">
          {% if detail.descriptions %}
            <p class="text-muted">{{ detail.descriptions }}</p>
          {% endif %}
        </div>

        <!-- Footer: Like + Comment -->
        <div class="card-footer bg-white">

          <div class="d-flex justify-content-between align-items-center mb-3">

            <!-- Like Button -->
<div class="like-container">
<button
  class="like-btn {% if request.user in detail.user_like.all %}active{% endif %}"
  data-url="{% url 'posts:like' detail.id %}"
  onclick="like(this)">

  <svg class="like-icon"
       xmlns="http://www.w3.org/2000/svg"
       width="22"
       height="22"
       viewBox="0 0 24 24"
       style="pointer-events:none">
    <path d="M20.8 4.6c-1.4-1.4-3.6-1.4-5 0L12 8.4l-3.8-3.8c-1.4-1.4-3.6-1.4-5 0s-1.4 3.6 0 5L12 21l8.8-11.4c1.4-1.4 1.4-3.6 0-5z"/>
  </svg>

  <span class="like-count">{{ detail.user_like.count }}</span>
</button>

</div>


            <!-- Comment toggle -->
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#comments">
              ğŸ’¬
              <small>{{ comments.count }}</small>
            </button>

          </div>

          <!-- Comments Section -->
          <div class="collapse show" id="comments">

            <!-- Existing comments -->
<div class="mb-3">
  {% for comment in comments %}
    <div class="d-flex gap-3 mb-3 align-items-start">

      <img src="{{ comment.user.avatar.url }}"
           class="rounded-circle"
           width="35"
           height="35"
           style="object-fit: cover;">

      <div class="bg-light rounded px-3 py-2 w-100 position-relative">

        <div class="d-flex justify-content-between align-items-start">
          <a href="{% url 'profiles:profile' comment.user.username %}">
            <strong>{{ comment.user.username }}</strong>
          </a>

          {% if request.user == comment.user %}
          <div class="dropdown">
            <button class="btn btn-sm p-0 border-0 bg-transparent"
                    type="button"
                    data-bs-toggle="dropdown">
              â‹®
            </button>

            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <form method="post" action="{% url 'posts:delete_comment' comment.id %}">
                  {% csrf_token %}
                  <button class="dropdown-item text-danger" type="submit">
                    Delete
                  </button>
                </form>
              </li>
            </ul>
          </div>
          {% endif %}
        </div>

        <p class="mb-1 small">{{ comment.comment }}</p>

      </div>
    </div>
  {% empty %}
    <p class="text-muted small">No comments yet.</p>
  {% endfor %}
</div>


{% if user.is_authenticated %}
  <form action="{% url 'posts:detail_post' detail.id %}"
        method="POST"
        class="d-flex gap-2 align-items-start mt-3">

    {% csrf_token %}

    <div class="flex-grow-1">
      {{ form.comment }}
      {% if form.comment.errors %}
        <div class="text-danger small mt-1">
          {{ form.comment.errors }}
        </div>
      {% endif %}
    </div>

    <button class="btn btn-primary px-4">
      Send
    </button>

  </form>
{% else %}
  <div class="mt-3">
    <p class="text-muted small mb-1">
      You need to be logged in to comment.
    </p>
    <a href="{% url 'account:login' %}" class="small">
      Login
    </a>
  </div>
{% endif %}


          </div>

        </div>

      </div>

    </div>
  </div>
</div>

<!-- CSS -->
<style>
.like-btn {
  border: 1px solid #eee;
  background: #fff;
}
.like-btn:hover {
  background: #f8f9fa;
}
.like-icon {
  transition: all 0.2s ease;
}
.like-btn.liked .like-icon {
  fill: #dc3545;
  stroke: #dc3545;
  transform: scale(1.2);
}
.like-btn .like-icon {
  fill: none;      /* ÙˆÙ‚ØªÛŒ Ù„Ø§ÛŒÚ© Ù†ÛŒØ³Øª Ø³ÙÛŒØ¯ */
  stroke: red;     /* ÙÙ‚Ø· Ø®Ø· Ù‚Ø±Ù…Ø² */
}

.like-btn.active .like-icon {
  fill: red;       /* ÙˆÙ‚ØªÛŒ Ù„Ø§ÛŒÚ© Ø´Ø¯ Ù‚Ø±Ù…Ø² */
}

</style>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');



function like(el){
  const url = el.dataset.url;
  const countEl = el.querySelector('.like-count');
  const icon = el.querySelector('.like-icon');

  $.ajax({
    url: url,
    type: 'POST',
    headers: {
      'X-CSRFToken': csrftoken
    },
    dataType: 'json'
  }).done(res => {
    if (res.status === 'liked'){
      el.classList.add('active');       // Ù‚Ø±Ù…Ø²
      countEl.innerText = Number(countEl.innerText) + 1;
    } else if (res.status === 'like') {
      el.classList.remove('active');    // Ø³ÙÛŒØ¯
      countEl.innerText = Number(countEl.innerText) - 1;
    }
  }).fail(err => {
    console.error('LIKE ERROR', err.responseText);
  });
}


</script>


{% endblock content %}
